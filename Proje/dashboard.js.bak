
// Client'Ä± baÅŸlat
supabaseClient = initSupabase();

document.addEventListener('DOMContentLoaded', async () => {

    // --- 1. OTURUM VE PROFÄ°L VERÄ°LERÄ° ---
    const { data: { user } } = await supabaseClient.auth.getUser();

    if (!user) {
        window.location.href = 'index.html';
        return;
    }

    // Elemanlar
    const userEmailEl = document.getElementById('userEmail');
    const userNameEl = document.getElementById('userName');
    const userImageEl = document.getElementById('userImage');
    const streakCountEl = document.getElementById('streakCount');

    // Sidebar Edit ElemanlarÄ±
    const sidebarMainView = document.getElementById('sidebarMainView');
    const sidebarEditView = document.getElementById('sidebarEditView');
    const btnProfileEdit = document.getElementById('btnProfileEdit');
    const btnCancelEdit = document.getElementById('btnCancelEdit');
    const btnSaveProfile = document.getElementById('btnSaveProfile');
    const btnNewAvatar = document.getElementById('btnNewAvatar');

    const editDisplayName = document.getElementById('editDisplayName');
    const editUserImage = document.getElementById('editUserImage');

    userEmailEl.innerText = user.email;
    if (user.user_metadata && user.user_metadata.display_name) {
        userNameEl.innerText = user.user_metadata.display_name;
    }

    // DB'den avatar ve streak Ã§ek
    const { data: profile } = await supabaseClient
        .from('profiles')
        .select('*, login_streaks(streak_count)')
        .eq('id', user.id)
        .single();

    let currentAvatarUrl = '';
    let profileExists = false; // Profil var mÄ± kontrolÃ¼

    if (profile) {
        profileExists = true; // Profil bulundu
        currentAvatarUrl = profile.avatar_url || user.user_metadata.avatar_url || `https://api.dicebear.com/7.x/avataaars/svg?seed=${user.email}`;

        userNameEl.innerText = profile.display_name || user.user_metadata.display_name;
        userImageEl.src = currentAvatarUrl;

        // Streak MantÄ±ÄŸÄ±
        let streak = 0;
        if (profile.login_streaks) {
            if (Array.isArray(profile.login_streaks) && profile.login_streaks.length > 0) {
                streak = profile.login_streaks[0].streak_count;
            } else if (typeof profile.login_streaks === 'object') {
                streak = profile.login_streaks.streak_count || 0;
            }
        }

        if (streakCountEl) {
            streakCountEl.innerText = `ðŸ”¥ ${streak} GÃ¼nlÃ¼k Seri`;
            streakCountEl.style.color = '#ff9f1c';
            streakCountEl.style.fontWeight = 'bold';
            streakCountEl.style.fontSize = '0.9rem';
        }

    } else {
        currentAvatarUrl = user.user_metadata.avatar_url || `https://api.dicebear.com/7.x/avataaars/svg?seed=${user.email}`;
        userImageEl.src = currentAvatarUrl;
    }

    // --- PROFÄ°L DÃœZENLEME MANTIÄžI ---

    // Edit Modunu AÃ§
    btnProfileEdit.addEventListener('click', () => {
        sidebarMainView.style.display = 'none';
        sidebarEditView.style.display = 'flex';

        // Mevcut verileri doldur
        editDisplayName.value = userNameEl.innerText;
        editUserImage.src = userImageEl.src;
    });

    // Ä°ptal Et
    btnCancelEdit.addEventListener('click', () => {
        sidebarEditView.style.display = 'none';
        sidebarMainView.style.display = 'flex';
    });

    // Yeni Random Avatar
    btnNewAvatar.addEventListener('click', () => {
        const randomSeed = Math.random().toString(36).substring(7);
        const newUrl = `https://api.dicebear.com/7.x/avataaars/svg?seed=${randomSeed}`;
        editUserImage.src = newUrl;
    });

    // Kaydet
    btnSaveProfile.addEventListener('click', async () => {
        const newName = editDisplayName.value.trim();
        const newAvatar = editUserImage.src;

        if (!newName) {
            alert("Ä°sim boÅŸ olamaz!");
            return;
        }

        btnSaveProfile.innerText = "Kaydediliyor...";

        // Supabase Ä°ÅŸlemi (Update veya Insert)
        let error;

        if (profileExists) {
            // Profil varsa GÃœNCELLE (Update)
            const res = await supabaseClient
                .from('profiles')
                .update({
                    display_name: newName,
                    avatar_url: newAvatar,
                    updated_at: new Date().toISOString()
                })
                .eq('id', user.id);
            error = res.error;
        } else {
            // Profil yoksa EKLE (Insert)
            const res = await supabaseClient
                .from('profiles')
                .insert({
                    id: user.id,
                    display_name: newName,
                    avatar_url: newAvatar,
                    updated_at: new Date().toISOString()
                });
            error = res.error;
        }

        if (error) {
            console.error('Hata DetayÄ±:', error);
            alert(`Kaydetme baÅŸarÄ±sÄ±z!\nHata: ${error.message}`);
            btnSaveProfile.innerText = "Kaydet";
        } else {
            // UI GÃ¼ncelle
            userNameEl.innerText = newName;
            userImageEl.src = newAvatar;

            // EÄŸer yeni oluÅŸturulduysa flag'i gÃ¼ncelle
            profileExists = true;

            // GÃ¶rÃ¼nÃ¼m DeÄŸiÅŸtir
            sidebarEditView.style.display = 'none';
            sidebarMainView.style.display = 'flex';

            btnSaveProfile.innerText = "Kaydet";

            // BaÅŸarÄ± mesajÄ± (Opsiyonel)
            // alert("Profil baÅŸarÄ±yla gÃ¼ncellendi!");
        }
    });


    // --- 2. HÄ°YERARÅžÄ°K VERÄ° YAPISI: Kategori -> Ders -> Hoca -> Playlist -> Videolar ---
    const schema = {
        'LGS': {
            icon: 'fa-graduation-cap',
            desc: 'Liseye GeÃ§iÅŸ SÄ±navÄ±',
            subjects: {
                'LGS Matematik': {
                    teachers: [
                        {
                            name: 'PartikÃ¼l Matematik',
                            image: 'https://yt3.googleusercontent.com/ytc/AIdro_k6k_lq9Jq6_lq9Jq6_lq9Jq6_lq9Jq6=s176-c-k-c0x00ffffff-no-rj',
                            playlists: [
                                {
                                    title: 'LGS 2025 Matematik KampÄ±', videos: [
                                        { title: 'Ã‡arpanlar ve Katlar 1', videoId: 'J_zF3gX1wGs', views: '850 K' }, // Temsili ID (PartikÃ¼l)
                                        { title: 'ÃœslÃ¼ Ä°fadeler - GiriÅŸ', videoId: '8sJ2sl7eQ4I', views: '700 K' }
                                    ]
                                }
                            ]
                        },
                        {
                            name: 'TonguÃ§ 8. SÄ±nÄ±f',
                            image: 'https://yt3.googleusercontent.com/ytc/AIdro_k6k_lq9Jq6_lq9Jq6_lq9Jq6_lq9Jq6=s176-c-k-c0x00ffffff-no-rj',
                            playlists: [
                                {
                                    title: '8. SÄ±nÄ±f Matematik', videos: [
                                        { title: 'LGS Matematik Deneme Ã‡Ã¶zÃ¼mÃ¼', videoId: 'rs_QMZ7G-0k', views: '2 Mn' }
                                    ]
                                }
                            ]
                        }
                    ]
                },
                'LGS Fen Bilimleri': {
                    teachers: [
                        { name: 'TonguÃ§ LGS', image: '', playlists: [{ title: 'LGS Fen Full Tekrar', videos: [{ title: 'Mevsimler ve Ä°klim', videoId: 'W6NZfCO5SIk', views: '1.2 Mn' }] }] }
                    ]
                }
            }
        },
        'YKS': {
            icon: 'fa-university',
            desc: 'Ãœniversite sÄ±navÄ±na hazÄ±rlÄ±k',
            subjects: {
                'TYT Matematik': {
                    teachers: [
                        {
                            name: 'Mert Hoca',
                            image: 'https://yt3.googleusercontent.com/ytc/AIdro_k6k_lq9Jq6_lq9Jq6_lq9Jq6_lq9Jq6=s176-c-k-c0x00ffffff-no-rj', // Temsili
                            playlists: [
                                {
                                    title: '70 GÃ¼nde TYT Matematik KampÄ±', videos: [
                                        { title: 'Kamp TanÄ±tÄ±mÄ±', videoId: 'rs_QMZ7G-0k', views: '1.2 Mn' },
                                        { title: 'Temel Kavramlar 1', videoId: 'J_zF3gX1wGs', views: '2.5 Mn' },
                                        { title: 'Tek Ã‡ift SayÄ±lar', videoId: '8sJ2sl7eQ4I', views: '1.8 Mn' }
                                    ]
                                },
                                {
                                    title: 'TYT Full Tekrar', videos: [
                                        { title: 'TÃ¼m Konular Ã–zet', videoId: 'rs_QMZ7G-0k', views: '900 K' }
                                    ]
                                }
                            ]
                        },
                        {
                            name: 'Rehber Matematik',
                            image: 'https://yt3.googleusercontent.com/ytc/AIdro_k6k_lq9Jq6_lq9Jq6_lq9Jq6_lq9Jq6=s176-c-k-c0x00ffffff-no-rj',
                            playlists: [
                                {
                                    title: '49 GÃ¼nde TYT Matematik', videos: [
                                        { title: '1. GÃ¼n - Temel Kavramlar', videoId: 'J_zF3gX1wGs', views: '3 Mn' },
                                        { title: '2. GÃ¼n - SayÄ± BasamaklarÄ±', videoId: '1_M11zZ7zWw', views: '2.1 Mn' }
                                    ]
                                }
                            ]
                        }
                    ]
                },
                'TYT Fizik': {
                    teachers: [
                        {
                            name: 'VIP Fizik',
                            image: 'https://yt3.googleusercontent.com/ytc/AIdro_k6k_lq9Jq6_lq9Jq6_lq9Jq6_lq9Jq6=s176-c-k-c0x00ffffff-no-rj',
                            playlists: [
                                {
                                    title: 'TYT Fizik KampÄ± 2025', videos: [
                                        { title: 'Fizik Bilimine GiriÅŸ', videoId: 'W6NZfCO5SIk', views: '1.5 Mn' },
                                        { title: 'Madde ve Ã–zellikleri', videoId: '8sJ2sl7eQ4I', views: '1.1 Mn' }
                                    ]
                                }
                            ]
                        }
                    ]
                }
            }
        },
        'KODLAMA': {
            icon: 'fa-laptop-code',
            desc: 'YazÄ±lÄ±m ve Teknoloji',
            subjects: {
                'Veri Bilimi': {
                    teachers: [
                        {
                            name: 'Vahit Keskin',
                            image: 'https://yt3.googleusercontent.com/ytc/AIdro_k6k_lq9Jq6_lq9Jq6_lq9Jq6_lq9Jq6=s176-c-k-c0x00ffffff-no-rj',
                            playlists: [
                                {
                                    title: 'Veri Bilimi ve Makine Ã–ÄŸrenimi', videos: [
                                        { title: 'Veri Bilimi Nedir?', videoId: 'rfscVS0vtbw', views: '150 K' },
                                        { title: 'Python ile Veri Analizi', videoId: '5p2hgy5V2t8', views: '120 K' }
                                    ]
                                }
                            ]
                        },
                        {
                            name: 'Merve AyyÃ¼ce TÃ¼rker',
                            image: 'https://yt3.googleusercontent.com/ytc/AIdro_k6k_lq9Jq6_lq9Jq6_lq9Jq6_lq9Jq6=s176-c-k-c0x00ffffff-no-rj',
                            playlists: [
                                {
                                    title: 'Derin Ã–ÄŸrenmeye GiriÅŸ', videos: [
                                        { title: 'Yapay Zeka ve Derin Ã–ÄŸrenme', videoId: 'JMUxmLyrhSk', views: '200 K' }
                                    ]
                                }
                            ]
                        }
                    ]
                },
                'Python': {
                    teachers: [
                        {
                            name: 'SadÄ±k Turan',
                            image: 'https://yt3.googleusercontent.com/ytc/AIdro_k6k_lq9Jq6_lq9Jq6_lq9Jq6_lq9Jq6=s176-c-k-c0x00ffffff-no-rj',
                            playlists: [
                                {
                                    title: 'SÄ±fÄ±rdan Ä°leri Seviye Python', videos: [
                                        { title: 'Python Nedir?', videoId: 'rfscVS0vtbw', views: '800 K' },
                                        { title: 'DeÄŸiÅŸkenler', videoId: '5p2hgy5V2t8', views: '500 K' }
                                    ]
                                }
                            ]
                        },
                        {
                            name: 'YazÄ±lÄ±m Bilimi',
                            image: 'https://yt3.googleusercontent.com/ytc/AIdro_k6k_lq9Jq6_lq9Jq6_lq9Jq6_lq9Jq6=s176-c-k-c0x00ffffff-no-rj',
                            playlists: [
                                {
                                    title: 'Python Dersleri', videos: [
                                        { title: 'GiriÅŸ', videoId: 'rfscVS0vtbw', views: '2 Mn' }
                                    ]
                                }
                            ]
                        }
                    ]
                },
                'Javascript': {
                    teachers: [
                        {
                            name: 'Mosh Hamedani',
                            image: 'https://yt3.googleusercontent.com/ytc/AIdro_k6k_lq9Jq6_lq9Jq6_lq9Jq6_lq9Jq6=s176-c-k-c0x00ffffff-no-rj',
                            playlists: [
                                {
                                    title: 'JS for Beginners', videos: [
                                        { title: 'JS in 1 Hour', videoId: 'W6NZfCO5SIk', views: '12 Mn' }
                                    ]
                                }
                            ]
                        }
                    ]
                }
            }
        },
        'KPSS': {
            icon: 'fa-book-open',
            desc: 'Kamu Personeli SeÃ§me SÄ±navÄ±',
            subjects: {
                'KPSS Tarih': {
                    teachers: [
                        {
                            name: 'Ramazan Yetgin',
                            image: 'https://yt3.googleusercontent.com/ytc/AIdro_k6k_lq9Jq6_lq9Jq6_lq9Jq6_lq9Jq6=s176-c-k-c0x00ffffff-no-rj',
                            playlists: [
                                {
                                    title: '2025 KPSS Tarih', videos: [
                                        { title: 'Ä°slamiyet Ã–ncesi TÃ¼rk Tarihi', videoId: 'J_zF3gX1wGs', views: '3.2 Mn' }, // Temsili ID (Ramazan Yetgin Bulunamadi)
                                        { title: 'TÃ¼rk Ä°slam Tarihi 1', videoId: '1_M11zZ7zWw', views: '2.5 Mn' }
                                    ]
                                }
                            ]
                        }
                    ]
                },
                'KPSS CoÄŸrafya': {
                    teachers: [
                        {
                            name: 'Engin EraydÄ±n',
                            image: 'https://yt3.googleusercontent.com/ytc/AIdro_k6k_lq9Jq6_lq9Jq6_lq9Jq6_lq9Jq6=s176-c-k-c0x00ffffff-no-rj',
                            playlists: [
                                { title: '2025 KPSS CoÄŸrafya', videos: [{ title: 'TÃ¼rkiye\'nin CoÄŸrafi Konumu', videoId: '8sJ2sl7eQ4I', views: '1.8 Mn' }] }
                            ]
                        }
                    ]
                }
            }
        },
        'DÄ°L': {
            icon: 'fa-language',
            desc: 'YabancÄ± dil eÄŸitimi',
            subjects: {
                'Ä°ngilizce': {
                    teachers: [
                        {
                            name: 'Ã–zer Kiraz',
                            image: 'https://yt3.googleusercontent.com/ytc/AIdro_k6k_lq9Jq6_lq9Jq6_lq9Jq6_lq9Jq6=s176-c-k-c0x00ffffff-no-rj',
                            playlists: [
                                {
                                    title: 'SÄ±fÄ±rdan Ä°ngilizce', videos: [
                                        { title: 'Ders 1 - TanÄ±ÅŸma', videoId: 'juKd26qkNAw', views: '5 Mn' }
                                    ]
                                }
                            ]
                        },
                        {
                            name: 'EnglishClass101',
                            image: 'https://yt3.googleusercontent.com/ytc/AIdro_k6k_lq9Jq6_lq9Jq6_lq9Jq6_lq9Jq6=s176-c-k-c0x00ffffff-no-rj',
                            playlists: [
                                {
                                    title: 'Basics of English', videos: [
                                        { title: '30 Minutes English', videoId: 'juKd26qkNAw', views: '15 Mn' }
                                    ]
                                }
                            ]
                        }
                    ]
                }
            }
        }
    };


    // --- 3. NAVÄ°GASYON MANTIÄžI ---
    const contentGrid = document.getElementById('contentGrid');
    const navBar = document.getElementById('navBar');
    const backBtn = document.getElementById('backBtn');
    const pageTitle = document.getElementById('pageTitle');

    // State
    let currentLevel = 'main'; // main -> category -> subject -> teacher -> playlist -> video
    let selectedCategory = null;
    let selectedSubject = null;
    let selectedTeacher = null;
    let selectedPlaylist = null;

    // BaÅŸlangÄ±Ã§
    renderMainCategories();

    backBtn.addEventListener('click', () => {
        if (currentLevel === 'video') {
            renderPlaylists(selectedTeacher); // Video -> Playlist'e dÃ¶n
        } else if (currentLevel === 'playlist') {
            renderTeachers(selectedSubject); // Playlist -> Hoca'ya dÃ¶n
        } else if (currentLevel === 'teacher') {
            renderSubjects(selectedCategory); // Hoca -> Ders'e dÃ¶n
        } else if (currentLevel === 'subject') {
            renderMainCategories(); // Ders -> Ana Sayfa'ya dÃ¶n
        } else {
            renderMainCategories();
        }
    });

    // --- RENDER FONKSÄ°YONLARI ---

    function renderMainCategories() {
        currentLevel = 'main';
        navBar.style.display = 'none';
        contentGrid.innerHTML = '';

        Object.keys(schema).forEach(catKey => {
            const cat = schema[catKey];
            const div = document.createElement('div');
            div.className = 'category-card';
            div.innerHTML = `
                <div class="category-icon"><i class="fas ${cat.icon}"></i></div>
                <h3>${catKey}</h3>
                <p>${cat.desc}</p>
            `;
            div.addEventListener('click', () => {
                selectedCategory = catKey;
                renderSubjects(catKey);
            });
            contentGrid.appendChild(div);
        });
    }

    function renderSubjects(catKey) {
        currentLevel = 'subject';
        navBar.style.display = 'flex';
        pageTitle.innerText = `${catKey} - Ders SeÃ§imi`;
        contentGrid.innerHTML = '';

        const subjects = schema[catKey].subjects;
        const subjectNames = Object.keys(subjects);

        subjectNames.forEach(subName => {
            const div = document.createElement('div');
            div.className = 'subject-card';
            div.innerHTML = `
                <div class="subject-info">
                    <h4>${subName}</h4>
                    <span>${catKey}</span>
                </div>
                <div class="subject-arrow"><i class="fas fa-chevron-right"></i></div>
            `;
            div.addEventListener('click', () => {
                selectedSubject = subName;
                renderTeachers(subName);
            });
            contentGrid.appendChild(div);
        });
    }

    function renderTeachers(subject) {
        currentLevel = 'teacher';
        pageTitle.innerText = `${subject} - EÄŸitmen SeÃ§imi`;
        contentGrid.innerHTML = '';

        const teachers = schema[selectedCategory].subjects[subject].teachers;

        teachers.forEach(teacher => {
            const div = document.createElement('div');
            div.className = 'teacher-card';
            div.innerHTML = `
                <div class="teacher-avatar">
                   <img src="${teacher.image || 'https://api.dicebear.com/7.x/avataaars/svg?seed=' + teacher.name}" 
                        style="width:100%; height:100%; border-radius:50%; object-fit:cover;">
                </div>
                <h3>${teacher.name}</h3>
                <p>${teacher.playlists.length} Oynatma Listesi</p>
             `;
            div.addEventListener('click', () => {
                selectedTeacher = teacher;
                renderPlaylists(teacher);
            });
            contentGrid.appendChild(div);
        });
    }

    function renderPlaylists(teacher) {
        currentLevel = 'playlist';
        pageTitle.innerText = `${teacher.name} - EÄŸitim Setleri`;
        contentGrid.innerHTML = '';

        teacher.playlists.forEach(playlist => {
            const div = document.createElement('div');
            div.className = 'playlist-card';
            div.innerHTML = `
                 <div class="playlist-icon"><i class="fas fa-layer-group"></i></div>
                 <h3>${playlist.title}</h3>
                 <p>${playlist.videos.length} Video</p>
            `;
            div.addEventListener('click', () => {
                selectedPlaylist = playlist;
                renderPlaylistVideos(playlist);
            });
            contentGrid.appendChild(div);
        });
    }

    function renderPlaylistVideos(playlist) {
        currentLevel = 'video';
        pageTitle.innerText = `${playlist.title}`;
        contentGrid.innerHTML = '';

        if (playlist.videos.length === 0) {
            contentGrid.innerHTML = `<p style="grid-column: 1/-1; text-align: center; color: #888;">Bu listede video bulunamadÄ±.</p>`;
            return;
        }

        playlist.videos.forEach(video => {
            const card = document.createElement('div');
            card.className = 'video-card';

            const thumbUrl = `https://i.ytimg.com/vi/${video.videoId}/hqdefault.jpg`;

            card.addEventListener('click', () => {
                window.open(`https://www.youtube.com/watch?v=${video.videoId}`, '_blank');
            });

            card.innerHTML = `
                <div class="thumbnail-container">
                    <img src="${thumbUrl}" alt="${video.title}">
                    <span class="badge" style="background: var(--error);"><i class="fab fa-youtube"></i> YouTube</span>
                </div>
                <div class="video-info">
                    <h3 style="font-size: 1rem; line-height:1.4;">${video.title}</h3>
                    <div class="video-footer" style="margin-top:10px;">
                        <span style="font-size: 0.8rem; color: #666;">
                            <i class="fas fa-eye"></i> ${video.views || 'Bilinmiyor'}
                        </span>
                        <button class="watch-btn">Ä°zle</button>
                    </div>
                </div>
            `;
            contentGrid.appendChild(card);
        });
    }

    // --- Ã‡IKIÅž YAP ---
    document.getElementById('logoutBtn').addEventListener('click', async () => {
        if (supabaseClient) await supabaseClient.auth.signOut();
        window.location.href = 'index.html';
    });
});
